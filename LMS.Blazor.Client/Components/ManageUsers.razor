@page "/manage-users"
@using LMS.Shared.DTOs.UsersDtos
@using LMS.Shared.DTOs.Common
@using LMS.Blazor.Client.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject IApiService ApiService

<div class="manage-users container-fluid">
    <div class="row">

        <!-- Left column: Create / Edit User Form -->
        <div class="col-md-5">
            <div class="card sticky-top" style="top: 1rem; z-index: 2;">
                <div class="card-body">
                    <h6 class="card-title">@((isEditing ? "Update User" : "Create New User"))</h6>

                    @if (isEditing)
                    {
                        <!-- Update form -->
                        <EditForm Model="@updateForm" OnValidSubmit="@SaveUser">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <!-- Username -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Username</label>
                                <InputText class="form-control form-control-sm" @bind-Value="updateForm.UserName" />
                                <ValidationMessage For="@(() => updateForm.UserName)" />
                            </div>

                            <!-- Email -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Email</label>
                                <InputText class="form-control form-control-sm" @bind-Value="updateForm.Email" />
                                <ValidationMessage For="@(() => updateForm.Email)" />
                            </div>

                            <!-- First Name -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">First Name</label>
                                <InputText class="form-control form-control-sm" @bind-Value="updateForm.FirstName" />
                                <ValidationMessage For="@(() => updateForm.FirstName)" />
                            </div>

                            <!-- Last Name -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Last Name</label>
                                <InputText class="form-control form-control-sm" @bind-Value="updateForm.LastName" />
                                <ValidationMessage For="@(() => updateForm.LastName)" />
                            </div>

                            <!-- Role -->
                            <div class="mb-3">
                                <label class="form-label small mb-1">Role</label>
                                <select class="form-select form-select-sm" @bind="updateForm.Role">
                                    <option value="Student">Student</option>
                                    <option value="Teacher">Teacher</option>
                                </select>
                            </div>

                            <!-- Course -->
                            <div class="mb-3">
                                <label class="form-label small mb-1">Course</label>
                                <select class="form-select form-select-sm" @bind="updateForm.CourseId">
                                    <option value="">-- None --</option>
                                    @foreach (var c in courses)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </select>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-success me-2" type="submit">Update</button>
                                <button class="btn btn-sm btn-secondary" type="button" @onclick="ResetForm">Cancel</button>
                            </div>
                        </EditForm>
                    }
                    else
                    {
                        <!-- Create form -->
                        <EditForm Model="@createForm" OnValidSubmit="@SaveNewUser">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <!-- Username -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Username</label>
                                <InputText class="form-control form-control-sm" @bind-Value="createForm.UserName" />
                                <ValidationMessage For="@(() => createForm.UserName)" />
                            </div>

                            <!-- Email -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Email</label>
                                <InputText class="form-control form-control-sm" @bind-Value="createForm.Email" />
                                <ValidationMessage For="@(() => createForm.Email)" />
                            </div>

                            <!-- Password -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Password</label>
                                <InputText type="password" class="form-control form-control-sm" @bind-Value="createForm.Password" />
                                <ValidationMessage For="@(() => createForm.Password)" />
                            </div>

                            <!-- First Name -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">First Name</label>
                                <InputText class="form-control form-control-sm" @bind-Value="createForm.FirstName" />
                                <ValidationMessage For="@(() => createForm.FirstName)" />
                            </div>

                            <!-- Last Name -->
                            <div class="mb-2">
                                <label class="form-label small mb-1">Last Name</label>
                                <InputText class="form-control form-control-sm" @bind-Value="createForm.LastName" />
                                <ValidationMessage For="@(() => createForm.LastName)" />
                            </div>

                            <!-- Role -->
                            <div class="mb-3">
                                <label class="form-label small mb-1">Role</label>
                                <select class="form-select form-select-sm" @bind="createForm.Role">
                                    <option value="Student">Student</option>
                                    <option value="Teacher">Teacher</option>
                                </select>
                            </div>

                            <!-- Course -->
                            <div class="mb-3">
                                <label class="form-label small mb-1">Course</label>
                                <select class="form-select form-select-sm" @bind="createForm.CourseId">
                                    <option value="">-- None --</option>
                                    @foreach (var c in courses)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </select>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-success me-2" type="submit">Create</button>
                                <button class="btn btn-sm btn-secondary" type="button" @onclick="ResetForm">Cancel</button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>

        <!-- Right column: User List -->
        <div class="col-md-7">
            <div class="input-group mb-3">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input class="form-control" placeholder="Filter users..."
                       @bind="userFilter" @bind:event="oninput" />
                <button class="btn btn-outline-secondary"
                        @onclick="() => userFilter = string.Empty"
                        disabled="@string.IsNullOrWhiteSpace(userFilter)">
                    Clear
                </button>
            </div>

            @if (isLoading)
            {
                <p>Loading users...</p>
            }
            else if (errorMessage is not null)
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            else
            {
                <ul class="list-group" style="max-height: 26rem; overflow-y: auto;">
                    @foreach (var user in FilteredUsers)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="flex-fill">
                                <strong>@(user.FullName ?? user.UserName ?? "(No name)")</strong><br />
                                <small class="text-muted">@user.Email</small><br />
                                @if (!string.IsNullOrEmpty(user.CourseName))
                                {
                                    <small class="text-info">Course: @user.CourseName</small>
                                }
                            </span>

                            <div class="btn-group ms-2">
                                <button class="btn btn-sm @(IsTeacher(user) ? "btn-warning" : "btn-info")" disabled>
                                    @if (IsTeacher(user))
                                    {
                                        <i class="bi bi-mortarboard me-1"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-book me-1"></i>
                                    }
                                </button>
                                <button class="btn btn-sm btn-outline-primary ms-1" @onclick="() => StartEditUser(user)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteUser(user.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <!-- ❌ Removed assign button -->
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
</div>

@code {
    private List<UserDto>? users;
    private List<CourseDto> courses = new();

    private bool isLoading = true;
    private string? errorMessage;
    private string userFilter = string.Empty;

    private bool isEditing = false;
    private string? editingUserId;

    private CreateUserForm createForm = new();
    private UpdateUserForm updateForm = new();

    // 🔹 Filtering support
    private IEnumerable<UserDto> FilteredUsers =>
        string.IsNullOrWhiteSpace(userFilter)
            ? (users ?? Enumerable.Empty<UserDto>())
            : (users ?? Enumerable.Empty<UserDto>())
                .Where(u =>
                    StartsWithIgnoreCase(u.FullName, userFilter) ||
                    StartsWithIgnoreCase(u.UserName, userFilter) ||
                    StartsWithIgnoreCase(u.Email, userFilter))
                .OrderBy(u => u.FullName ?? u.UserName ?? u.Email);

    private static bool StartsWithIgnoreCase(string? value, string prefix) =>
        !string.IsNullOrWhiteSpace(value) &&
        !string.IsNullOrWhiteSpace(prefix) &&
        value.StartsWith(prefix, StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await LoadCourses();
    }

    private async Task LoadUsers()
    {
        try
        {
            isLoading = true;
            var page = await ApiService.CallApiAsync<PagedResult<UserDto>>("api/users?size=50");
            users = page?.Items?.ToList() ?? new List<UserDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load users: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCourses()
    {
        try
        {
            var list = await ApiService.CallApiAsync<List<CourseDto>>("api/courses?includeModules=false&includeActivities=false");
            courses = list ?? new List<CourseDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load courses: {ex.Message}";
        }
    }

    private async Task SaveNewUser()
    {
        var dto = new CreateUserDto
        {
            UserName = createForm.UserName,
            Email = createForm.Email,
            Password = createForm.Password,
            FirstName = createForm.FirstName,
            LastName = createForm.LastName,
            Roles = new List<string> { createForm.Role }
        };

        var created = await ApiService.PostAsync<UserDto>("api/users", dto);
        if (created != null)
        {
            users ??= new();
            users.Add(created);

            if (createForm.CourseId.HasValue)
            {
                await AssignUserToCourse(created.Id, createForm.CourseId.Value);

                var course = await ApiService.CallApiAsync<CourseDto>($"api/courses/{createForm.CourseId}");
                var updated = created with
                {
                    CourseId = course?.Id,
                    CourseName = course?.Name
                };
                users[users.IndexOf(created)] = updated;
            }
        }
        ResetForm();
    }

    private async Task SaveUser()
    {
        var dto = new UpdateUserDto
        {
            UserName = updateForm.UserName,
            Email = updateForm.Email,
            FirstName = updateForm.FirstName,
            LastName = updateForm.LastName,
            Roles = new List<string> { updateForm.Role }
        };

        // Update the user
        var success = await ApiService.PutAsync($"api/users/{editingUserId}", dto);

        // Update roles separately
        var roleSuccess = await ApiService.PutAsync(
            $"api/users/{editingUserId}/roles",
            new SetRolesDto { Roles = new List<string> { updateForm.Role } }
        );

        if (success && roleSuccess)
        {
            // Re-fetch the updated user from the API
            var updatedUser = await ApiService.CallApiAsync<UserDto>($"api/users/{editingUserId}");

            if (updatedUser != null)
            {
                // If course assignment changed, handle it
                var newCourseId = updateForm.CourseId;

                if (newCourseId.HasValue)
                {
                    await AssignUserToCourse(updatedUser.Id, newCourseId.Value);

                    var course = await ApiService.CallApiAsync<CourseDto>($"api/courses/{newCourseId}");
                    updatedUser = updatedUser with
                    {
                        CourseId = course?.Id,
                        CourseName = course?.Name
                    };
                }
                else
                {
                    // Unassign if needed
                    if (updatedUser.CourseId.HasValue)
                        await UnassignUserFromCourse(updatedUser.Id, updatedUser.CourseId.Value);

                    updatedUser = updatedUser with { CourseId = null, CourseName = null };
                }

                // Replace in local list
                if (users != null)
                {
                    var idx = users.FindIndex(u => u.Id == updatedUser.Id);
                    if (idx >= 0)
                        users[idx] = updatedUser;
                }
            }
        }

        ResetForm();
    }

    private async Task AssignUserToCourse(string userId, int courseId)
    {
        await ApiService.PostAsync<object>($"api/courses/{courseId}/users/{userId}", new { });
    }

    private async Task UnassignUserFromCourse(string userId, int courseId)
    {
        await ApiService.DeleteAsync($"api/courses/{courseId}/users/{userId}");
    }

    private void StartEditUser(UserDto user)
    {
        isEditing = true;
        editingUserId = user.Id;
        updateForm = new UpdateUserForm
        {
            UserName = user.UserName ?? "",
            Email = user.Email ?? "",
            FirstName = user.FirstName ?? "",
            LastName = user.LastName ?? "",
            Role = user.Roles?.FirstOrDefault() ?? "Student",
            CourseId = user.CourseId
        };
    }

    private void ResetForm()
    {
        isEditing = false;
        editingUserId = null;
        createForm = new CreateUserForm();
        updateForm = new UpdateUserForm();
    }

    private async Task DeleteUser(string id)
    {
        if (await ApiService.DeleteAsync($"api/users/{id}"))
            users?.RemoveAll(u => u.Id == id);
    }

    private bool IsTeacher(UserDto user) =>
        user.Roles?.Contains("Teacher") == true;

    private class CreateUserForm
    {
        [Required, StringLength(50)] public string UserName { get; set; } = "";
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, StringLength(100, MinimumLength = 6)] public string Password { get; set; } = "";
        [Required, StringLength(50)] public string FirstName { get; set; } = "";
        [Required, StringLength(50)] public string LastName { get; set; } = "";
        [Required] public string Role { get; set; } = "Student";
        public int? CourseId { get; set; }
    }

    private class UpdateUserForm
    {
        [Required, StringLength(50)] public string UserName { get; set; } = "";
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, StringLength(50)] public string FirstName { get; set; } = "";
        [Required, StringLength(50)] public string LastName { get; set; } = "";
        [Required] public string Role { get; set; } = "Student";
        public int? CourseId { get; set; }
    }

    private class CourseDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }
}