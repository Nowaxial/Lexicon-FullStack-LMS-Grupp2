@page "/manage-modules"
@using LMS.Shared.DTOs.EntitiesDtos.ModulesDtos
@using LMS.Shared.DTOs.EntitiesDtos.ProjActivity
@using LMS.Blazor.Client.Services

<div class="row">
    <div class="col-12">
        @if (isLoading)
        {
            <p class="text-muted">Loading module...</p>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        else if (activeModule == null)
        {
            <p class="text-muted">No module selected.</p>
        }
        else
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    @if (editingModuleId == activeModule.Id)
                    {
                        <!-- Edit Module -->
                        <div class="row g-2 mb-2">
                            <div class="col-md-6">
                                <InputText class="form-control" @bind-Value="moduleEditModel.Name" />
                            </div>
                            <div class="col-md-6">
                                <InputText class="form-control" @bind-Value="moduleEditModel.Description" />
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <InputDate class="form-control" @bind-Value="moduleEditModel.Starts" />
                            </div>
                            <div class="col-md-6">
                                <InputDate class="form-control" @bind-Value="moduleEditModel.Ends" />
                            </div>
                        </div>

                        <button class="btn btn-success btn-sm me-2" @onclick="SaveModule">
                            <i class="bi bi-check2"></i> Save
                        </button>
                        <button class="btn btn-secondary btn-sm" @onclick="CancelEditModule">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    }
                    else
                    {
                        <!-- Display Module -->
                        <h4>@activeModule.Name</h4>
                        <p class="text-muted">@activeModule.Starts – @activeModule.Ends</p>
                        <p>@activeModule.Description</p>

                        <button class="btn btn-sm btn-outline-primary me-2"
                                @onclick="() => StartEditModule(activeModule)">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger"
                                @onclick="() => DeleteModule(activeModule.Id)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    }

                    <hr />

                    <!-- Activities filter -->
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input class="form-control" placeholder="Filter activities..."
                               @bind="activityFilter" @bind:event="oninput" />
                    </div>

                    <div style="max-height: 300px; overflow-y: auto;">
                        <ul class="list-group list-group-flush">

                            <!-- Add Activity Row -->
                            <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                <div class="flex-fill">
                                    <div class="row g-2">
                                        <div class="col">
                                            <InputText class="form-control form-control-sm" placeholder="Title" @bind-Value="addActivityModel.Title" />
                                        </div>
                                        <div class="col">
                                            <InputText class="form-control form-control-sm" placeholder="Type" @bind-Value="addActivityModel.Type" />
                                        </div>
                                        <div class="col">
                                            <input type="datetime-local"
                                                   class="form-control form-control-sm"
                                                   value="@addActivityModel.Starts.ToString("yyyy-MM-ddTHH:mm")"
                                                   @onchange="e => addActivityModel.Starts = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())" />
                                        </div>
                                        <div class="col">
                                            <input type="datetime-local"
                                                   class="form-control form-control-sm"
                                                   value="@addActivityModel.Ends.ToString("yyyy-MM-ddTHH:mm")"
                                                   @onchange="e => addActivityModel.Ends = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())" />
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group ms-2">
                                    <button class="btn btn-sm btn-success" @onclick="SaveNewActivity">
                                        <i class="bi bi-check2"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" @onclick="ResetAddActivityForm">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </li>

                            @if (FilteredActivities?.Any() == true)
                            {
                                @foreach (var a in FilteredActivities)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        @if (editingActivityId == a.Id)
                                        {
                                            <div class="flex-fill">
                                                <div class="row g-2">
                                                    <div class="col">
                                                        <InputText class="form-control form-control-sm" @bind-Value="activityEditModel.Title" />
                                                    </div>
                                                    <div class="col">
                                                        <InputText class="form-control form-control-sm" @bind-Value="activityEditModel.Type" />
                                                    </div>
                                                    <div class="col">
                                                        <input type="datetime-local"
                                                               class="form-control form-control-sm"
                                                               value="@activityEditModel.Starts.ToString("yyyy-MM-ddTHH:mm")"
                                                               @onchange="e => activityEditModel.Starts = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())" />
                                                    </div>
                                                    <div class="col">
                                                        <input type="datetime-local"
                                                               class="form-control form-control-sm"
                                                               value="@activityEditModel.Ends.ToString("yyyy-MM-ddTHH:mm")"
                                                               @onchange="e => activityEditModel.Ends = DateTime.Parse(e.Value?.ToString() ?? DateTime.Now.ToString())" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="btn-group ms-2">
                                                <button class="btn btn-sm btn-success" @onclick="() => SaveActivity(a.Id)">
                                                    <i class="bi bi-check2"></i>
                                                </button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelEditActivity">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="flex-fill">
                                                <strong>@a.Title</strong> (@a.Type)<br />
                                                <small>@a.Starts – @a.Ends</small>
                                            </span>
                                            <div class="btn-group ms-2">
                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => StartEditActivity(a)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteActivity(a.Id)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        }
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="list-group-item">
                                    <p class="text-muted small mb-0">No activities yet.</p>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>
</div>