@using LMS.Shared.DTOs.EntitiesDtos
@inject IJSRuntime JS

<div class="navstrip-wrapper">
    <div class="navstrip" @ref="navStripRef">

        @if (IsTeacher)
        {
            <!-- Add new course card -->
            <div class="navstrip-card-container add-card-container">
                <div class="navstrip-card add-card"
                     @onclick="OnAddCourseClick">
                    <i class="bi bi-plus-lg add-icon"></i>
                </div>
            </div>
        }

        @foreach (var (c, index) in (Items ?? Enumerable.Empty<CourseDto>()).Select((c, i) => (c, i)))
        {
            var isActive = ActiveItem?.Id == c.Id;
            var isExpanded = ExpandedCourseId == c.Id;

            <div class="navstrip-card-container @(isExpanded ? "expanded" : "")" id="@($"course-{c.Id}")">
                <div class="navstrip-card @(isActive ? "active" : "")"
                     @onclick="() => OnCourseClick(c, index)">

                    <div class="card-body">
                        <div class="course-main">
                            <h6>@c.Name</h6>
                            <small class="text-muted">@c.Starts – @c.Ends</small>
                        </div>

                        @if (isExpanded)
                        {
                            <div class="course-extra">
                                @c.Description
                            </div>
                        }
                    </div>

                    @if (isActive)
                    {
                        <!-- Expand / Collapse Arrow -->
                        <button class="expand-arrow"
                                @onclick="() => OnExpandClick(c)"
                                @onclick:stopPropagation>
                            <i class="bi @(isExpanded ? "bi-chevron-left" : "bi-chevron-right")"></i>
                        </button>
                    }

                    @if (isExpanded && IsTeacher)
                    {
                        <div class="card-actions">
                            <button class="card-action-btn"
                                    @onclick="() => OnEditCourseClick(c)"
                                    @onclick:stopPropagation>
                                <i class="bi bi-pencil-fill"></i>
                            </button>

                            <button class="card-action-btn"
                                    @onclick="() => OnDeleteCourseClick(c)"
                                    @onclick:stopPropagation>
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Custom draggable scrollbar -->
    <div class="navstrip-scrollbar">
        <div class="navstrip-scrollbar-thumb" id="@($"{Id}-thumb")"></div>
    </div>
</div>

@code {
    [Parameter] public List<CourseDto>? Items { get; set; }
    [Parameter] public CourseDto? ActiveItem { get; set; }
    [Parameter] public EventCallback<CourseDto> OnItemSelected { get; set; }
    [Parameter] public EventCallback OnAddCourse { get; set; }
    [Parameter] public EventCallback<CourseDto> OnDeleteCourse { get; set; }
    [Parameter] public string Id { get; set; } = "navstrip";
    [Parameter] public bool IsTeacher { get; set; } = false;

    private ElementReference navStripRef;
    private bool initialized;
    private int? ExpandedCourseId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Items?.Any() == true)
        {
            initialized = true;
            await JS.InvokeVoidAsync("initNavstripScrollbar", ".navstrip", $"#{Id}-thumb");
        }
    }

    private async Task OnCourseClick(CourseDto course, int index)
    {
        ActiveItem = course;
        await OnItemSelected.InvokeAsync(course);

        var elementId = $"course-{course.Id}";
        await JS.InvokeVoidAsync("scrollCourseIntoCenter", ".navstrip", elementId);

        StateHasChanged();
    }

    private void OnExpandClick(CourseDto course)
    {
        ExpandedCourseId = ExpandedCourseId == course.Id ? null : course.Id;
        StateHasChanged();
    }

    private void OnEditCourseClick(CourseDto course)
    {
        Console.WriteLine($"Edit course {course.Name}");
        // TODO: open edit modal
    }

    private async Task OnAddCourseClick()
    {
        if (OnAddCourse.HasDelegate)
        {
            await OnAddCourse.InvokeAsync();

            if (Items?.Any() == true)
            {
                var first = Items.First();
                ActiveItem = first;
                var elementId = $"course-{first.Id}";
                await JS.InvokeVoidAsync("scrollCourseIntoCenter", ".navstrip", elementId);
                await OnItemSelected.InvokeAsync(first);
            }
        }
    }

    private async Task OnDeleteCourseClick(CourseDto course)
    {
        if (OnDeleteCourse.HasDelegate)
        {
            await OnDeleteCourse.InvokeAsync(course);

            // Fallback: select first available course if active one was deleted
            if (ActiveItem?.Id == course.Id)
            {
                ActiveItem = Items?.FirstOrDefault();
                if (ActiveItem != null)
                {
                    var elementId = $"course-{ActiveItem.Id}";
                    await JS.InvokeVoidAsync("scrollCourseIntoCenter", ".navstrip", elementId);
                    await OnItemSelected.InvokeAsync(ActiveItem);
                }
            }
        }
    }
}