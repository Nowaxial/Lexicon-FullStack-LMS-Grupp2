@using LMS.Shared.DTOs.EntitiesDtos

<div class="navstrip-wrapper">
    <div class="navstrip" @ref="navStripRef">
        <div class="navstrip-spacer"></div>

        @foreach (var (c, index) in (Items ?? Enumerable.Empty<CourseDto>()).Select((c, i) => (c, i)))
        {
            var isActive = ActiveItem?.Id == c.Id;
            var isExpanded = ExpandedCourseId == c.Id;

            <div class="navstrip-card-container @(isExpanded ? "expanded" : "")" id="@($"course-{c.Id}")">
                <div class="navstrip-card @(isActive ? "active" : "")"
                     @onclick="() => OnCourseClick(c, index)">

                    <div class="card-body">
                        <div class="course-main">
                            <h6>@c.Name</h6>
                            <small class="text-muted">@c.Starts – @c.Ends</small>
                        </div>

                        @if (isExpanded)
                        {
                            <div class="course-extra">
                                @c.Description
                            </div>
                        }
                    </div>

                    @if (isActive)
                    {
                        <!-- Expand / Collapse Arrow -->
                        <button class="expand-arrow"
                                @onclick="() => OnExpandClick(c)"
                                @onclick:stopPropagation>
                            <i class="bi @(isExpanded ? "bi-chevron-left" : "bi-chevron-right")"></i>
                        </button>
                    }

                    @if (isExpanded)
                    {
                        <!-- Edit button (only when expanded) -->
                        <button class="edit-btn"
                                @onclick="() => OnEditCourseClick(c)"
                                @onclick:stopPropagation>
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                    }
                </div>
            </div>
        }

        <div class="navstrip-spacer"></div>
    </div>

    <!-- Custom draggable scrollbar -->
    <div class="navstrip-scrollbar">
        <div class="navstrip-scrollbar-thumb" id="@($"{Id}-thumb")"></div>
    </div>
</div>

@code {
    [Parameter] public IEnumerable<CourseDto>? Items { get; set; }
    [Parameter] public CourseDto? ActiveItem { get; set; }
    [Parameter] public EventCallback<CourseDto> OnItemSelected { get; set; }
    [Parameter] public string Id { get; set; } = "navstrip";
    [Parameter] public bool IsTeacher { get; set; } = false;

    private ElementReference navStripRef;
    private bool initialized;
    private int? ExpandedCourseId; // Track expanded course

    [Inject] private IJSRuntime JS { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Items?.Any() == true)
        {
            initialized = true;
            await JS.InvokeVoidAsync("initNavstripScrollbar", ".navstrip", $"#{Id}-thumb");
        }
    }

    private async Task OnCourseClick(CourseDto course, int index)
    {
        ActiveItem = course;
        await OnItemSelected.InvokeAsync(course);

        var elementId = $"course-{course.Id}";
        await JS.InvokeVoidAsync("scrollCourseIntoCenter", ".navstrip", elementId);

        StateHasChanged();
    }

    private void OnExpandClick(CourseDto course)
    {
        ExpandedCourseId = ExpandedCourseId == course.Id ? null : course.Id;
        StateHasChanged();
    }

    private void OnEditCourseClick(CourseDto course)
    {
        Console.WriteLine($"Edit course {course.Name}");
        // TODO: open edit modal
    }

    [JSInvokable]
    public async Task OnCenteredIndexChanged(int index)
    {
        if (Items != null && index >= 0 && index < Items.Count())
        {
            var selected = Items.ElementAt(index);
            ActiveItem = selected;
            await OnItemSelected.InvokeAsync(selected);
            StateHasChanged();
        }
    }
}

<style>

</style>