@using LMS.Shared.DTOs.EntitiesDtos.ModulesDtos
@using LMS.Shared.DTOs.EntitiesDtos.ProjActivity
@inject IJSRuntime JS

<div class="modules-strip-wrapper">
    <!-- Left button -->
    <button class="carousel-btn left @(IsTeacher && ActiveIndex == 0 ? "teacher-add" : "")"
            type="button"
            @onclick="OnLeftClick"
            disabled="@IsLeftDisabled">
        <i class="@LeftIcon"></i>
    </button>

    <div class="modules-strip d-flex flex-row flex-nowrap" @ref="modulesStripRef">
        <div class="module-spacer"></div>

@foreach (var (m, index) in EditableModules.Select((m, i) => (m, i)))
{
    <div class="module-card-container" id="@($"module-{m.Id}")">
        <div class="module-card @(index == ActiveIndex ? "active" : "disabled-module")"
             @onclick="() => OnModuleClick(index)">
            
            @if (IsTeacher && index == ActiveIndex) 
            {
                <!-- Small edit button -->
                <button class="module-edit-btn"
                        title="Redigera modul"
                        @onclick="() => OnEditModuleClick(m)"
                        @onclick:stopPropagation>
                    <i class="bi bi-pencil"></i>
                </button>
            }

            <div class="card-body d-flex flex-column">
                <h6 class="mb-1">@m.Name</h6>
                <p class="text-muted small mb-1">@m.Starts – @m.Ends</p>
                <p class="small flex-shrink-0">@m.Description</p>

                @if (m.Activities?.Any() == true)
                {
                    <ul class="activities-list mt-2">
                        @foreach (var a in m.Activities)
                        {
                            <li class="activity-item">
                                <div class="activity-title">@a.Title <span class="text-muted">(@a.Type)</span></div>
                                <div class="activity-dates">@a.Starts – @a.Ends</div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted small mt-2">Inga aktiviteter ännu.</p>
                }
            </div>
        </div>
    </div>
}

        <div class="module-spacer"></div>
    </div>

    <!-- Right button -->
    <button class="carousel-btn right"
            type="button"
            @onclick="OnRightClick"
            disabled="@IsRightDisabled">
        <i class="@RightIcon"></i>
    </button>
</div>

@code {
    [Parameter] public IEnumerable<ModuleDto>? Modules { get; set; }
    [Parameter] public string Id { get; set; } = "modulestrip";
    [Parameter] public bool IsTeacher { get; set; } = false;
    [Parameter] public int CourseId { get; set; }

    [Parameter] public EventCallback OnAddModule { get; set; }
    [Parameter] public EventCallback<ModuleDto> OnEditModuleRequested { get; set; }

    // 👇 New param to allow parent to set which module should be selected
    [Parameter] public int? SelectedModuleId { get; set; }

    private List<ModuleDto> EditableModules = new();
    private ElementReference modulesStripRef;
    private int ActiveIndex = 0;

    protected override void OnParametersSet()
    {
        EditableModules = Modules?.ToList() ?? new();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (SelectedModuleId.HasValue)
        {
            var module = EditableModules.FirstOrDefault(m => m.Id == SelectedModuleId.Value);
            if (module != null)
            {
                await SelectModuleAsync(module);
            }
        }
    }

    private string LeftIcon =>
        (IsTeacher && ActiveIndex == 0) ? "bi bi-plus-lg text-success" : "bi bi-chevron-left";

    private string RightIcon => "bi bi-chevron-right";

    private bool IsLeftDisabled => ActiveIndex == 0 && !IsTeacher;
    private bool IsRightDisabled => ActiveIndex >= EditableModules.Count - 1;

    private async Task OnLeftClick()
    {
        if (IsTeacher && ActiveIndex == 0)
        {
            if (OnAddModule.HasDelegate)
                await OnAddModule.InvokeAsync();
        }
        else
        {
            await Scroll(-1);
        }
    }

    private async Task OnRightClick() => await Scroll(1);

    private async Task Scroll(int direction)
    {
        if (!EditableModules.Any()) return;

        ActiveIndex = Math.Clamp(ActiveIndex + direction, 0, EditableModules.Count - 1);
        await JS.InvokeVoidAsync("scrollStrip", ".modules-strip", direction);
    }

    private async Task OnModuleClick(int index)
    {
        ActiveIndex = index;
        await JS.InvokeVoidAsync("scrollStrip", ".modules-strip", 0);
    }

    public async Task SelectModuleAsync(ModuleDto module)
    {
        var index = EditableModules.FindIndex(m => m.Id == module.Id);
        if (index >= 0)
        {
            ActiveIndex = index;

            var elementId = $"module-{module.Id}";
            await JS.InvokeVoidAsync("scrollModuleIntoCenter", ".modules-strip", elementId);

            // ❌ don’t call StateHasChanged() here
        }
    }

    private async Task OnEditModuleClick(ModuleDto module)
    {
        if (OnEditModuleRequested.HasDelegate)
            await OnEditModuleRequested.InvokeAsync(module);
    }
}