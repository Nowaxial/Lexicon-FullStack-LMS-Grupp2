@page "/manage-courses"
@using LMS.Shared.DTOs.EntitiesDtos
@using LMS.Shared.DTOs.EntitiesDtos.ModulesDtos
@using LMS.Shared.DTOs.EntitiesDtos.ProjActivity
@using LMS.Blazor.Client.Services

@if (isLoading)
{
    <!-- Loading spinner -->
    <div class="d-flex justify-content-center align-items-center p-5">
        <div class="spinner-border text-primary me-2" role="status"></div>
        <span>Laddar kurser…</span>
    </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <!-- Error state -->
    <div class="alert alert-danger m-3">
        @error
    </div>
}
else
{
    <!-- Teacher Tools -->
    <div class="accordion mb-4" id="teacherToolsAccordion">
        <!-- Manage Users -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingUsers">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseUsers"
                        aria-expanded="false" aria-controls="collapseUsers"
                        @onclick="() => usersAccordionExpanded = true">
                    <i class="bi bi-people me-2"></i> Hantera användare
                </button>
            </h2>
            <div id="collapseUsers" class="accordion-collapse collapse"
                 aria-labelledby="headingUsers" data-bs-parent="#teacherToolsAccordion">
                <div class="accordion-body">
                    @if (usersAccordionExpanded)
                    {
                        <ManageUsers />
                    }
                    else
                    {
                        <p class="text-muted">Expandera för att ladda användare…</p>
                    }
                </div>
            </div>
        </div>

        <!-- Manage Modules -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingModules">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseModules"
                        aria-expanded="false" aria-controls="collapseModules">
                    <i class="bi bi-journal-text me-2"></i> Hantera moduler
                </button>
            </h2>
            <div id="collapseModules" class="accordion-collapse collapse"
                 aria-labelledby="headingModules" data-bs-parent="#teacherToolsAccordion">
                <div class="accordion-body">
                    <ManageModules SelectedModule="selectedModuleToEdit"
                                   OnModuleUpdated="HandleModuleUpdated"
                                   OnModuleDeleted="HandleModuleDeleted" />
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingSearch">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapseSearch"
                        aria-expanded="false" aria-controls="collapseSearch">
                    <i class="bi bi-search me-2"></i> Sök
                </button>
            </h2>
            <div id="collapseSearch" class="accordion-collapse collapse"
                 aria-labelledby="headingSearch" data-bs-parent="#teacherToolsAccordion">
                <div class="accordion-body">
                    <SearchBar OnResultSelected="HandleSearchResult" />
                </div>
            </div>
        </div>
    </div>

    @if (selectedCourse != null)
    {
        <div class="active-course mb-4">
            @if (courses != null && courses.Any())
            {
                <NavStrip Items="courses"
                          ActiveItem="selectedCourse"
                          OnItemSelected="OnCourseSelected"
                          OnAddCourse="AddCourseAsync"
                          OnDeleteCourse="DeleteCourseAsync"
                          OnSaveCourse="SaveCourseAsync"
                          IsTeacher="IsTeacher"
                          Id="courseNav" />
            }

            <!-- Modules viewer -->
            <ModuleStrip @ref="moduleStripRef"
                         Modules="selectedCourse?.Modules"
                         CourseId="selectedCourse?.Id ?? 0"
                         Id="moduleViewer"
                         IsTeacher="IsTeacher"
                         SelectedModuleId="selectedModuleId"
                         OnEditModuleRequested="HandleEditModule"
                         OnAddModule="HandleAddModule" />
        </div>
    }
}

@code {
    private bool usersAccordionExpanded = false;
}