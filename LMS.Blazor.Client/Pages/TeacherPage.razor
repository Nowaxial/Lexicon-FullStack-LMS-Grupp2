@page "/teacher"
@rendermode InteractiveWebAssembly
@attribute [Authorize(Roles = "Teacher")]
@namespace LMS.Blazor.Client.Components.Pages

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Lärare</PageTitle>

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
        <h2 class="text-muted">Loading…</h2>
    </div>
}
else
{
    <AuthorizeView Roles="Teacher" Context="ctx">
        <Authorized>
            <section class="container-fluid lms-container teacher-wrap py-4">
                <h1 class="display-6 fw-bold mb-4">Välkommen, @displayName!</h1>
                <div class="row g-4">
                    <div class="col-12 col-lg-8">
                        <article class="dash-card">
                            <div class="d-flex flex-column">
                                <div class="dash-card__head">Mina kurser</div>

                                @foreach (var c in Courses)
                                {
                                    <div class="course-row">
                                        <div class="course-row__title">@c.Title</div>
                                        <div class="course-row__meta">
                                            <div><span class="label">Elever</span><span>@c.Students</span></div>
                                            <div><span class="label">Startdatum</span><span>@c.StartDate.ToString("dd MMM")</span></div>
                                        </div>
                                        <div class="course-row__actions">
                                            <NavLink class="btn btn-sm btn-outline-light" href="@($"courses/{c.Id}")">Visa</NavLink>
                                            <NavLink class="btn btn-sm btn-outline-secondary btn-light" href="@($"courses/{c.Id}/edit")">Hantera</NavLink>
                                        </div>
                                    </div>
                                }

                                <div>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary float-end"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#addCourseTeacherPage">
                                        Skapa kurs
                                    </button>
                                </div>

                                <div class="collapse mb-3" id="addCourseTeacherPage">
                                    <div class="card card-body">
                                        <EditForm Model="newCourse" OnValidSubmit="AddCourseAsync" FormName="add-course-form">
                                            <DataAnnotationsValidator />
                                            <ValidationSummary />

                                            <div class="mb-2">
                                                <InputText class="form-control" placeholder="Name" @bind-Value="newCourse.Name" />
                                            </div>

                                            <div class="mb-2">
                                                <InputTextArea class="form-control" placeholder="Description" @bind-Value="newCourse.Description" />
                                            </div>

                                            <div class="mb-2">
                                                <InputDate class="form-control" @bind-Value="newCourse.Starts" />
                                            </div>

                                            <div class="mb-2">
                                                <InputDate class="form-control" @bind-Value="newCourse.Ends" />
                                            </div>

                                            <button type="submit" class="btn btn-primary">Create Course</button>
                                        </EditForm>
                                    </div>
                                </div>
                            </div>
                        </article>
                        <article class="dash-card mt-4">
                            <div class="dash-card__head">Kommande aktiviteter</div>

                            @{
                                var top = Upcoming.Take(7).ToList();
                                var rest = Upcoming.Skip(7).ToList();
                                var hasMore = rest.Count > 0;
                                var collapseId = "upcoming-more";
                            }

                            <div class="table-responsive">
                                <table class="table table-sm table-borderless align-middle m-0">
                                    <thead>
                                        <tr class="text-muted">
                                            <th style="width: 140px;">Datum</th>
                                            <th>Aktivitet</th>
                                            <th style="width: 160px;" class="text-end">Kurs</th>
                                        </tr>
                                    </thead>

                                    @if ((Upcoming?.Count ?? 0) == 0)
                                    {
                                        <tbody>
                                            <tr>
                                                <td colspan="3" class="text-muted">Inga kommande aktiviteter.</td>
                                            </tr>
                                        </tbody>
                                    }
                                    else
                                    {
                                        <tbody>
                                            @foreach (var a in top)
                                            {
                                                <tr class="rowline">
                                                    <!-- Datum (Module above date) -->
                                                    <td class="text-nowrap align-middle" style="width:140px;">
                                                        <div class="d-flex flex-column text-start">
                                                            <small class="text-muted">Modul @a.ModuleId</small>
                                                            <span class="acts-data">@a.Starts.ToString("dd MMM")</span>
                                                        </div>
                                                    </td>

                                                    <!-- Aktivitet -->
                                                    <td>
                                                        <div class="fw-semibold">@a.Title</div>
                                                        @if (!string.IsNullOrWhiteSpace(a.Description))
                                                        {
                                                            <small class="text-muted d-block text-truncate" style="max-width:36rem;">
                                                                @a.Description
                                                            </small>
                                                        }
                                                    </td>

                                                    <!-- Kurs -->
                                                    <td class="text-end text-nowrap" style="width:160px;">
                                                        <a class="link-accent" href="@($"/courses/{a.CourseId}")">
                                                            @CourseTitle(a.CourseId)
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>

                                        @if (hasMore)
                                        {
                                            <!-- Collapsed extra rows -->
                                            <tbody id="@collapseId" class="collapse">
                                                @foreach (var a in rest)
                                                {
                                                    <tr class="rowline">
                                                        <td class="text-nowrap align-middle" style="width:140px;">
                                                            <div class="d-flex flex-column text-start">
                                                                <small class="text-muted">Modul @a.ModuleId</small>
                                                                <span>@a.Starts.ToString("dd MMM")</span>
                                                            </div>
                                                        </td>

                                                        <td>
                                                            <div class="fw-semibold">@a.Title</div>
                                                            @if (!string.IsNullOrWhiteSpace(a.Description))
                                                            {
                                                                <small class="text-muted d-block">@a.Description</small>
                                                            }
                                                        </td>

                                                        <td class="text-end text-nowrap" style="width:160px;">
                                                            <a class="link-accent" href="@($"/courses/{a.CourseId}")">
                                                                @CourseTitle(a.CourseId)
                                                            </a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        }
                                    }
                                </table>
                            </div>

                            @if (hasMore)
                            {
                                <div class="text-end mt-2">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="button"
                                            @onclick="ToggleUpcoming"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#@collapseId"
                                            aria-expanded="false"
                                            aria-controls="@collapseId">
                                        @(showMoreUpcoming ? "Dölja" : $"Visa fler ({rest.Count})")
                                    </button>
                                </div>
                            }
                        </article>

                    </div>

                    <div class="col-12 col-lg-4">
                        <article class="dash-card-muted">
                            <div class="dash-card__head">Snabba åtgärder</div>
                            <ul class="action-list list-unstyled m-0">
                                <li><a href="kurser/skapa" class="action-link">Skapa kurs</a></li>
                                <li><a href="moduler/skapa" class="action-link">Skapa modul</a></li>
                                <li><a href="aktiviteter/skapa" class="action-link ">Skapa aktivitet</a></li>
                            </ul>
                        </article>

                        <article class="dash-card mt-4">
                            <div class="dash-card__head d-flex justify-content-between align-items-center">
                                <span>Moduler</span>
                            </div>
                            <ul class="list-unstyled m-0">
                                @foreach (var m in Modules)
                                {
                                    <li class="module-row">
                                        <div class="fw-semibold">@m.Title</div>
                                        <small class="text-muted">@m.Items st uppgifter</small>
                                    </li>
                                }
                            </ul>
                        </article>

                        <article class="dash-card mt-4">
                            <div class="dash-card__head">Nya inlämningar</div>
                            <ul class="inbox list-unstyled m-0">
                                @foreach (var s in Submissions)
                                {
                                    <li class="inbox-row">
                                        <div>
                                            <div class="fw-semibold">@s.Assignment</div>
                                            <small class="text-muted">@s.Student · @s.Status</small>
                                        </div>
                                        <a class="chev" href="@($"inlamningar/{s.Id}")">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </article>
                    </div>
                </div>
            </section>
        </Authorized>

        <NotAuthorized>
            <div class="container py-5">
                <div class="alert alert-warning">Du måste vara inloggad som lärare för att visa denna sida.</div>
                <NavLink class="btn btn-primary" href="Account/Login">Logga in</NavLink>
            </div>
        </NotAuthorized>
    </AuthorizeView>

    <script src="app.js"></script>
}
