@page "/teacher"
@rendermode InteractiveWebAssembly
@attribute [Authorize(Roles = "Teacher")]
@namespace LMS.Blazor.Client.Components.Pages

@using LMS.Shared.DTOs.EntitiesDtos.ModulesDtos
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms

<PageTitle>Lärare</PageTitle>

@if (isLoading)
{
    <p class="text-muted">Loading…</p>
}
else
{

<AuthorizeView Roles="Teacher" Context="ctx">
    <Authorized>
        <section class="container-fluid lms-container teacher-wrap py-4">
                <div class="d-flex flex-row justify-content-between">
                    <h1 class="display-6 fw-bold mb-4">Välkommen, @displayName!</h1>
                <div class="side-head position-sticky">
                    <button type="button"
                                class="btn btn-outline-secondary btn-create">
                        Skapa kurs
                    </button>
                </div>
             </div>


            <div class="row g-4">
                <div class="col-12 col-lg-8">
                    <article class="dash-card">
                        <div class="d-flex flex-column">
                            <div class="dash-card__head">Mina kurser</div>

                            @foreach (var c in Courses)
                            {
                                <div class="course-row">
                                    <div class="course-row__title">@c.Title</div>
                                    <div class="course-row__meta">
                                        <div><span class="label">Elever</span><span>@c.Students</span></div>
                                        <div><span class="label">Startdatum</span><span>@c.StartDate.ToString("dd MMM")</span></div>
                                    </div>
                                    <div class="course-row__actions">
                                        <NavLink class="btn btn-sm btn-outline-light" href="@($"courses/{c.Id}")">Visa</NavLink>
                                            <NavLink class="btn btn-sm btn-outline-secondary btn-light" href="@($"courses/{c.Id}/edit")">Hantera</NavLink>
                                    </div>
                                </div>
                            }
                        </div>
                    </article>


                        <article class="dash-card mt-4">
                            <div class="dash-card__head">Kommande aktiviteter</div>

                            @{
                                var top = Upcoming.Take(7).ToList();
                                var rest = Upcoming.Skip(7).ToList();
                                var hasMore = rest.Count > 0;
                                var collapseId = "upcoming-more";
                            }

                            <div class="table-responsive">
                                <table class="table table-sm table-borderless align-middle m-0">
                                    <thead>
                                        <tr class="text-muted">
                                            <th style="width: 140px;">Datum</th>
                                            <th>Aktivitet</th>
                                            <th style="width: 160px;" class="text-end">Kurs</th>
                                        </tr>
                                    </thead>

                                    @if ((Upcoming?.Count ?? 0) == 0)
                                    {
                                        <tbody>
                                            <tr>
                                                <td colspan="3" class="text-muted">Inga kommande aktiviteter.</td>
                                            </tr>
                                        </tbody>
                                    }
                                    else
                                    {
                                        <tbody>
                                            @foreach (var a in top)
                                            {
                                                <tr class="rowline">
                                                    <!-- Datum (Module above date) -->
                                                    <td class="text-nowrap align-middle" style="width:140px;">
                                                        <div class="d-flex flex-column text-start">
                                                            <small class="text-muted">Modul @a.ModuleId</small>
                                                            <span class="acts-data">@a.Starts.ToString("dd MMM")</span>
                                                        </div>
                                                    </td>

                                                    <!-- Aktivitet -->
                                                    <td>
                                                        <div class="fw-semibold">@a.Title</div>
                                                        @if (!string.IsNullOrWhiteSpace(a.Description))
                                                        {
                                                            <small class="text-muted d-block text-truncate" style="max-width:36rem;">
                                                                @a.Description
                                                            </small>
                                                        }
                                                    </td>

                                                    <!-- Kurs -->
                                                    <td class="text-end text-nowrap" style="width:160px;">
                                                        <a class="link-accent" href="@($"/courses/{a.CourseId}")">
                                                            @CourseTitle(a.CourseId)
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>

                                        @if (hasMore)
                                        {
                                            <!-- Collapsed extra rows -->
                                            <tbody id="@collapseId" class="collapse">
                                                @foreach (var a in rest)
                                                {
                                                    <tr class="rowline">
                                                        <td class="text-nowrap align-middle" style="width:140px;">
                                                            <div class="d-flex flex-column text-start">
                                                                <small class="text-muted">Modul @a.ModuleId</small>
                                                                <span>@a.Starts.ToString("dd MMM")</span>
                                                            </div>
                                                        </td>

                                                        <td>
                                                            <div class="fw-semibold">@a.Title</div>
                                                            @if (!string.IsNullOrWhiteSpace(a.Description))
                                                            {
                                                                <small class="text-muted d-block">@a.Description</small>
                                                            }
                                                        </td>

                                                        <td class="text-end text-nowrap" style="width:160px;">
                                                            <a class="link-accent" href="@($"/courses/{a.CourseId}")">
                                                                @CourseTitle(a.CourseId)
                                                            </a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        }
                                    }
                                </table>
                            </div>

                            @if (hasMore)
                            {
                                <div class="text-end mt-2">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="button"
                                            @onclick="ToggleUpcoming"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#@collapseId"
                                            aria-expanded="false"
                                            aria-controls="@collapseId">
                                        @(showMoreUpcoming ? "Dölja" : $"Visa fler ({rest.Count})")
                                    </button>
                                </div>
                            }
                        </article>

                </div>

                    
                    <div class="col-12 col-lg-4">

                        <article class="dash-card">
                            <div class="dash-card__head d-flex justify-content-between align-items-center">
                                <span>Moduler</span>
                                @{
                                    var totalCount = modules?.Count ?? 0;
                                    var totalPagesLocal = Math.Max(1, (int)Math.Ceiling(totalCount / (double)ModulesPageSize));
                                }
                                @if (totalCount > ModulesPageSize)
                                {
                                    <small class="text-muted">Sida @modulesPage av @totalPagesLocal</small>
                                }
                            </div>

                            @{
                                var list = modules ?? new List<ModuleDto>();
                                var count = list.Count;
                                var totalPages = Math.Max(1, (int)Math.Ceiling(count / (double)ModulesPageSize));

                                if (modulesPage < 1) { modulesPage = 1; }
                                if (modulesPage > totalPages) { modulesPage = totalPages; }

                                var skip = (modulesPage - 1) * ModulesPageSize;
                                var pageItems = list.Skip(skip).Take(ModulesPageSize).ToList();
                            }

                            @if (count == 0)
                            {
                                <div class="p-3 text-muted">Inga moduler att visa.</div>
                            }
                            else
                            {
                                <ul class="list-unstyled m-0">
                                    @foreach (var m in pageItems)
                                    {
                                        <li class="module-row">
                                            <small class="text-muted d-block">@CourseTitle(m.CourseId)</small>
                                            <div class="fw-semibold">@m.Name</div>
                                            <small class="text-muted">
                                                @m.Starts.ToString("yyyy-MM-dd") – @m.Ends.ToString("yyyy-MM-dd")
                                            </small>
                                        </li>
                                    }
                                </ul>

                                @if (totalPages > 1)
                                {
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <button class="btn btn-sm btn-outline-secondary"
                                                disabled="@(modulesPage <= 1)"
                                                @onclick="() => modulesPage = Math.Max(1, modulesPage - 1)">
                                            ‹ Föregående
                                        </button>

                                        <small class="text-muted">Sida @modulesPage / @totalPages</small>

                                        <button class="btn btn-sm btn-outline-secondary"
                                                disabled="@(modulesPage >= totalPages)"
                                                @onclick="() => modulesPage = Math.Min(totalPages, modulesPage + 1)">
                                            Nästa ›
                                        </button>
                                    </div>
                                }
                            }
                        </article>



                    <article class="dash-card mt-4">
                        <div class="dash-card__head">Nya inlämningar</div>
                        <ul class="inbox list-unstyled m-0">
                            @foreach (var s in Submissions)
                            {
                                <li class="inbox-row">
                                    <div>
                                        <div class="fw-semibold">@s.Assignment</div>
                                        <small class="text-muted">@s.Student · @s.Status</small>
                                    </div>
                                    <a class="chev" href="@($"inlamningar/{s.Id}")">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </article>
                </div>
            </div>
        </section>
    </Authorized>

    <NotAuthorized>
        <div class="container py-5">
            <div class="alert alert-warning">Du måste vara inloggad som lärare för att visa denna sida.</div>
            <NavLink class="btn btn-primary" href="Account/Login">Logga in</NavLink>
        </div>
    </NotAuthorized>
</AuthorizeView>

<script src="app.js"></script>

}