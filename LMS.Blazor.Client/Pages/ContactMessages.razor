@page "/contact-messages"
@using LMS.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Teacher")]
@inject IApiService ApiService

<PageTitle>Kontaktmeddelanden</PageTitle>

<div class="lms-content">
    <h3>Kontaktmeddelanden</h3>

    @if (messages != null)
    {
        @foreach (var message in messages)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5>@message.Subject</h5>
                    <small class="text-muted">@message.Timestamp.ToString("yyyy-MM-dd HH:mm")</small>

                    @if (decryptedMessages.ContainsKey(message.Id))
                    {
                        var decrypted = decryptedMessages[message.Id];
                        <div class="mt-3 p-3 bg-light rounded">
                            <strong>Från:</strong> @decrypted.Name (@decrypted.Email)<br>
                            <strong>Meddelande:</strong><br>
                            <div class="mt-2">@decrypted.Message</div>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-primary mt-2" @onclick="() => DecryptMessage(message.Id)">
                            <i class="bi bi-unlock"></i> Dekryptera meddelande
                        </button>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Laddar...</span>
            </div>
        </div>
    }
</div>

@code {
    private List<ContactMessageItem>? messages;
    private Dictionary<Guid, ContactMessageDto> decryptedMessages = new();

    protected override async Task OnInitializedAsync()
    {
        messages = await ApiService.CallApiAsync<List<ContactMessageItem>>("api/contactmessages");
    }

    private async Task DecryptMessage(Guid id)
    {
        var decrypted = await ApiService.CallApiAsync<ContactMessageDto>($"api/contactmessages/{id}/decrypt");
        if (decrypted != null)
        {
            decryptedMessages[id] = decrypted;
        }
    }
}
